<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>데이터 업로드 - Healthtant</title>
</head>
<body>
    <h1>데이터 업로드</h1>
    
    <!-- 데이터베이스 통계 -->
    <div>
        <h2>데이터베이스 통계</h2>
        <div id="statsGrid">
            <div>총 식품 수: <span id="foodCount">-</span></div>
            <div>총 가격 정보: <span id="priceCount">-</span></div>
            <div>평균 가격: <span id="avgPrice">-</span></div>
            <div>식품 카테고리: <span id="categoryCount">-</span></div>
        </div>
        <button onclick="loadStats()">통계 새로고침</button>
    </div>

    <!-- 파일 업로드 -->
    <div>
        <h2>파일 업로드</h2>
        <form id="uploadForm">
            <div>
                <label for="tableType">테이블 타입:</label>
                <select id="tableType" name="tableType" required>
                    <option value="food">Food (식품 정보)</option>
                    <option value="price">Price (가격 정보)</option>
                </select>
            </div>

            <div>
                <label for="uploadMode">업로드 모드:</label>
                <select id="uploadMode" name="uploadMode" required>
                    <option value="upsert">Upsert (삽입 또는 업데이트)</option>
                    <option value="insert">Insert (새 데이터만 삽입)</option>
                    <option value="update">Update (기존 데이터만 업데이트)</option>
                </select>
            </div>

            <div>
                <label for="csvFile">파일 선택 (CSV 또는 XLSX):</label>
                <input type="file" id="csvFile" name="csvFile" accept=".csv,.xlsx" required>
                <div id="fileInfo"></div>
            </div>

            <button type="submit" id="uploadBtn">업로드 시작</button>
        </form>

        <div id="loading" style="display: none;">
            <h3>데이터 처리 중...</h3>
            
            <!-- 진행상황 표시 -->
            <div id="progressContainer" style="display: none;">
                <div style="margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span id="currentStep">초기화 중...</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div style="width: 100%; height: 20px; background-color: #f0f0f0; border-radius: 10px; overflow: hidden;">
                        <div id="progressBar" style="width: 0%; height: 100%; background-color: #4CAF50; transition: width 0.3s ease;"></div>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <div>처리된 행: <span id="processedRows">0</span> / <span id="totalRows">0</span></div>
                    <div>예상 남은 시간: <span id="estimatedTime">계산 중...</span></div>
                </div>
                
                <div id="progressDetails" style="margin: 20px 0; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                    <div id="progressLog">진행상황을 확인하는 중...</div>
                </div>
            </div>
        </div>
        <div id="result"></div>
    </div>

    <!-- 템플릿 -->
    <div>
        <h2>템플릿</h2>
        <div>
            <h3>Food 테이블 템플릿</h3>
            <p>필수 컬럼: food_id, food_name, food_category, representative_food, nutritional_value_standard_amount, calorie, moisture, protein, fat, carbohydrate, weight, company_name</p>
            <button onclick="downloadTemplate('food')">Food 템플릿 다운로드</button>
        </div>

        <div>
            <h3>Price 테이블 템플릿</h3>
            <p>필수 컬럼: food_id, shop_name, price</p>
            <button onclick="downloadTemplate('price')">Price 템플릿 다운로드</button>
        </div>
    </div>

    <script>
        // 페이지 로드 시 통계 로드
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            setupFileInput();
        });

        // 파일 입력 설정
        function setupFileInput() {
            const fileInput = document.getElementById('csvFile');
            const fileInfo = document.getElementById('fileInfo');

            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const size = (file.size / 1024 / 1024).toFixed(2);
                    fileInfo.innerHTML = `선택된 파일: ${file.name} (${size} MB)`;
                } else {
                    fileInfo.innerHTML = '';
                }
            });
        }

        // 통계 로드
        async function loadStats() {
            try {
                const response = await fetch('/db-stats/');
                const data = await response.json();

                if (data.success) {
                    const stats = data.data;
                    document.getElementById('foodCount').textContent = stats.food.total_count;
                    document.getElementById('priceCount').textContent = stats.price.total_count;
                    document.getElementById('avgPrice').textContent = Math.round(stats.price.avg_price).toLocaleString() + '원';
                    document.getElementById('categoryCount').textContent = stats.food.categories.length;
                }
            } catch (error) {
                console.error('통계 로드 실패:', error);
            }
        }

        // 파일 업로드
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData();
            const fileInput = document.getElementById('csvFile');
            const tableType = document.getElementById('tableType').value;
            const uploadMode = document.getElementById('uploadMode').value;

            if (!fileInput.files[0]) {
                showResult('파일을 선택해주세요.', 'error');
                return;
            }

            formData.append('csv_file', fileInput.files[0]);
            formData.append('table_type', tableType);
            formData.append('upload_mode', uploadMode);

            // UI 상태 변경
            const uploadBtn = document.getElementById('uploadBtn');
            const loading = document.getElementById('loading');
            const progressContainer = document.getElementById('progressContainer');

            uploadBtn.disabled = true;
            loading.style.display = 'block';
            progressContainer.style.display = 'block';
            hideResult();

            try {
                const response = await fetch('/upload-csv/', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // 진행상황 추적 시작
                    const progressKey = result.data.progress_key;
                    console.log('업로드 응답:', result);
                    console.log('진행상황 키:', progressKey);
                    
                    if (progressKey) {
                        // 즉시 진행상황 표시 시작
                        document.getElementById('currentStep').textContent = '파일 업로드 완료, 데이터 처리 시작...';
                        document.getElementById('progressText').textContent = '0%';
                        document.getElementById('progressBar').style.width = '0%';
                        
                        // 진행상황 추적 시작
                        startProgressTracking(progressKey);
                    } else {
                        console.error('progress_key가 응답에 없습니다!');
                        showResult('진행상황 추적을 시작할 수 없습니다. progress_key가 없습니다.', 'error');
                        resetUploadUI();
                    }
                    
                    // 최종 결과는 진행상황 추적이 완료된 후 표시됨
                } else {
                    showResult(`업로드 실패: ${result.message}`, 'error');
                    resetUploadUI();
                }
            } catch (error) {
                showResult(`네트워크 오류: ${error.message}`, 'error');
                resetUploadUI();
            }
        });

        // 진행상황 추적 시작
        function startProgressTracking(progressKey) {
            console.log('=== 진행상황 추적 시작 ===');
            console.log('진행상황 키:', progressKey);
            console.log('현재 시간:', new Date().toLocaleTimeString());
            
            // 초기 진행상황 표시 - 서버 콘솔과 동일한 형식
            document.getElementById('progressLog').innerHTML = `
                <div style="margin: 5px 0; padding: 8px; background-color: #e8f5e8; border-radius: 5px; border-left: 4px solid #4caf50;">
                    <strong>✅ 진행상황 추적을 시작했습니다</strong>
                </div>
                <div style="margin: 3px 0; padding: 5px; background-color: #e3f2fd; border-radius: 3px; border-left: 3px solid #2196f3;">
                    진행상황 키: ${progressKey}
                </div>
                <div style="margin: 3px 0; padding: 5px; background-color: #fff3e0; border-radius: 3px; border-left: 3px solid #ff9800;">
                    시작 시간: ${new Date().toLocaleTimeString()}
                </div>
            `;
            document.getElementById('currentStep').textContent = '데이터 처리 준비 중...';
            
            let retryCount = 0;
            const maxRetries = 3;
            
            const progressInterval = setInterval(async () => {
                try {
                    console.log(`[${new Date().toLocaleTimeString()}] 진행상황 조회 시도 ${retryCount + 1}/${maxRetries}`);
                    console.log('요청 URL:', `/upload-progress/?progress_key=${progressKey}`);
                    
                    const response = await fetch(`/upload-progress/?progress_key=${progressKey}`);
                    
                    console.log('응답 상태:', response.status, response.statusText);
                    console.log('응답 헤더:', Object.fromEntries(response.headers.entries()));
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('진행상황 응답 데이터:', data);

                    if (data.success) {
                        const progress = data.data;
                        retryCount = 0; // 성공 시 재시도 카운트 리셋
                        
                        console.log('진행상황 상세:', {
                            status: progress.status,
                            current_step: progress.current_step,
                            progress_percentage: progress.progress_percentage,
                            processed_rows: progress.processed_rows,
                            total_rows: progress.total_rows
                        });
                        
                        // 진행상황이 실제로 업데이트되었는지 확인
                        if (progress.current_step && progress.current_step !== '초기화 중...') {
                            console.log('진행상황 UI 업데이트 실행');
                            updateProgressUI(progress);
                        } else {
                            console.log('아직 초기화 상태 - 대기 중...');
                            // 아직 초기화 상태라면 더 구체적인 메시지 표시
                            document.getElementById('currentStep').textContent = '데이터 처리 준비 중... 잠시만 기다려주세요.';
                            
                            // 진행상황 로그에 대기 상태 표시
                            const logElement = document.getElementById('progressLog');
                            const waitingMessage = `
                                <div style="margin: 5px 0; padding: 8px; background-color: #fff3e0; border-radius: 5px; border-left: 4px solid #ff9800;">
                                    <strong>⏳ 백엔드에서 데이터 처리를 시작하고 있습니다...</strong>
                                </div>
                                <div style="margin: 3px 0; padding: 5px; background-color: #fafafa; border-radius: 3px; font-size: 0.9em; color: #666;">
                                    잠시만 기다려주세요. 대용량 파일 처리 시 시간이 걸릴 수 있습니다.
                                </div>
                            `;
                            
                            // 기존 로그에 대기 메시지 추가
                            logElement.innerHTML += waitingMessage;
                            logElement.scrollTop = logElement.scrollHeight;
                        }

                        // 완료 또는 오류 상태인 경우 추적 중단
                        if (progress.status === 'completed' || progress.status === 'error') {
                            console.log('진행상황 추적 완료:', progress.status);
                            clearInterval(progressInterval);
                            
                            if (progress.status === 'completed') {
                                showFinalResult(progress);
                            } else {
                                showResult(`처리 중 오류 발생: ${progress.current_step}`, 'error');
                            }
                            
                            resetUploadUI();
                        }
                    } else {
                        console.error('진행상황 조회 실패:', data.message);
                        document.getElementById('progressLog').innerHTML = `진행상황 조회 실패: ${data.message}`;
                        retryCount++;
                    }
                } catch (error) {
                    console.error('진행상황 조회 중 오류:', error);
                    document.getElementById('progressLog').innerHTML = `진행상황 조회 오류: ${error.message}`;
                    retryCount++;
                    
                    // 재시도 횟수 초과 시 추적 중단
                    if (retryCount >= maxRetries) {
                        clearInterval(progressInterval);
                        showResult('진행상황 추적에 실패했습니다. 서버를 확인해주세요.', 'error');
                        resetUploadUI();
                    }
                    
                    // 오류가 지속되면 추적 중단
                    if (error.message.includes('404') || error.message.includes('500')) {
                        clearInterval(progressInterval);
                        showResult('진행상황 추적에 실패했습니다. 서버를 확인해주세요.', 'error');
                        resetUploadUI();
                    }
                }
            }, 2000); // 2초마다 진행상황 조회
            
            console.log('진행상황 추적 인터벌 설정 완료');
            
            // 60초 후에도 진행상황이 없으면 타임아웃 처리
            setTimeout(() => {
                clearInterval(progressInterval);
                const currentStep = document.getElementById('currentStep').textContent;
                if (currentStep === '데이터 처리 준비 중...' || currentStep === '초기화 중...') {
                    console.log('타임아웃 발생 - 진행상황 추적 중단');
                    showResult('데이터 처리 시작이 지연되고 있습니다. 잠시 후 다시 시도해주세요.', 'error');
                    resetUploadUI();
                }
            }, 60000);
        }

        // 진행상황 UI 업데이트
        function updateProgressUI(progress) {
            console.log('UI 업데이트 실행:', progress);
            
            // 진행률 바 업데이트
            document.getElementById('progressBar').style.width = progress.progress_percentage + '%';
            document.getElementById('progressText').textContent = progress.progress_percentage + '%';
            
            // 현재 단계 업데이트 - 서버 콘솔과 동일한 메시지 표시
            if (progress.current_step) {
                document.getElementById('currentStep').textContent = progress.current_step;
            }
            
            // 처리된 행 수 업데이트
            if (progress.processed_rows !== undefined) {
                document.getElementById('processedRows').textContent = progress.processed_rows;
            }
            if (progress.total_rows !== undefined) {
                document.getElementById('totalRows').textContent = progress.total_rows;
            }
            
            // 예상 남은 시간 업데이트
            if (progress.estimated_time) {
                document.getElementById('estimatedTime').textContent = progress.estimated_time;
            }
            
            // 진행상황 로그 업데이트 - 서버 콘솔과 동일한 형식
            const logElement = document.getElementById('progressLog');
            let logContent = '';
            
            // 현재 단계를 로그에 추가
            if (progress.current_step) {
                logContent += `<div style="margin: 5px 0; padding: 8px; background-color: #e3f2fd; border-radius: 5px; border-left: 4px solid #2196f3;">
                    <strong>${progress.current_step}</strong>
                </div>`;
            }
            
            // 진행률 정보 추가
            if (progress.progress_percentage !== undefined) {
                logContent += `<div style="margin: 3px 0; padding: 5px; background-color: #f1f8e9; border-radius: 3px; border-left: 3px solid #4caf50;">
                    진행률: ${progress.progress_percentage}%
                </div>`;
            }
            
            // 처리된 행 정보 추가
            if (progress.processed_rows !== undefined && progress.total_rows !== undefined) {
                logContent += `<div style="margin: 3px 0; padding: 5px; background-color: #fff3e0; border-radius: 3px; border-left: 3px solid #ff9800;">
                    처리된 행: ${progress.processed_rows} / ${progress.total_rows}
                </div>`;
            }
            
            // 예상 시간 정보 추가
            if (progress.estimated_time && progress.estimated_time !== '계산 중...') {
                logContent += `<div style="margin: 3px 0; padding: 5px; background-color: #fce4ec; border-radius: 3px; border-left: 3px solid #e91e63;">
                    예상 남은 시간: ${progress.estimated_time}
                </div>`;
            }
            
            // 상세 정보 추가 (서버에서 전송하는 details)
            if (progress.details && progress.details.length > 0) {
                progress.details.forEach(detail => {
                    logContent += `<div style="margin: 2px 0; padding: 4px; background-color: #fafafa; border-radius: 3px; font-size: 0.9em; color: #666;">
                        ${detail}
                    </div>`;
                });
            }
            
            // 로그 업데이트
            logElement.innerHTML = logContent;
            
            // 로그를 항상 최하단으로 스크롤
            logElement.scrollTop = logElement.scrollHeight;
        }

        // 최종 결과 표시
        function showFinalResult(progress) {
            if (progress.final_result) {
                const result = progress.final_result;
                showResult(`
                    <h3>업로드 완료!</h3>
                    <p>처리 시간: ${progress.execution_time}초</p>
                    <div>
                        <p><strong>처리 결과:</strong></p>
                        <ul>
                            <li>처리된 행: ${result.processed_rows}</li>
                            <li>삽입된 행: ${result.inserted_rows}</li>
                            <li>업데이트된 행: ${result.updated_rows}</li>
                            <li>건너뛴 행: ${result.skipped_rows}</li>
                            <li>오류 행: ${result.error_rows}</li>
                        </ul>
                    </div>
                    <div>
                        <h4>처리 상세:</h4>
                        ${result.details.map(detail => 
                            `<div style="margin: 5px 0; padding: 5px; background-color: #f8f9fa; border-radius: 3px;">${detail}</div>`
                        ).join('')}
                    </div>
                `, 'success');

                // 통계 새로고침
                setTimeout(loadStats, 1000);
            }
        }

        // 업로드 UI 초기화
        function resetUploadUI() {
            const uploadBtn = document.getElementById('uploadBtn');
            const loading = document.getElementById('loading');
            const progressContainer = document.getElementById('progressContainer');

            uploadBtn.disabled = false;
            loading.style.display = 'none';
            progressContainer.style.display = 'none';
            
            // 진행상황 초기화 - 더 명확한 메시지
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
            document.getElementById('currentStep').textContent = '업로드 대기 중...';
            document.getElementById('processedRows').textContent = '0';
            document.getElementById('totalRows').textContent = '0';
            document.getElementById('estimatedTime').textContent = '계산 중...';
            document.getElementById('progressLog').innerHTML = '새로운 업로드를 기다리는 중...';
        }

        // 결과 표시
        function showResult(message, type) {
            const result = document.getElementById('result');
            result.innerHTML = message;
            result.style.display = 'block';
            result.style.padding = '10px';
            result.style.margin = '10px 0';
            if (type === 'success') {
                result.style.backgroundColor = '#d4edda';
                result.style.border = '1px solid #c3e6cb';
                result.style.color = '#155724';
            } else {
                result.style.backgroundColor = '#f8d7da';
                result.style.border = '1px solid #f5c6cb';
                result.style.color = '#721c24';
            }
        }

        function hideResult() {
            document.getElementById('result').style.display = 'none';
        }

        // 템플릿 다운로드
        async function downloadTemplate(tableType) {
            try {
                const response = await fetch(`/csv-template/?table_type=${tableType}`);
                const data = await response.json();

                if (data.success) {
                    const template = data.data;
                    const csvContent = [template.columns.join(','), template.sample_data.join(',')].join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', `${tableType}_template.csv`);
                    link.style.visibility = 'hidden';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert('템플릿 다운로드 실패: ' + data.message);
                }
            } catch (error) {
                alert('템플릿 다운로드 중 오류가 발생했습니다: ' + error.message);
            }
        }
    </script>
</body>
</html> 