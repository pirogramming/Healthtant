<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% load static %}
    <link rel="stylesheet" href="{% static 'base/variables.css' %}" />
    <link rel="stylesheet" href="{% static 'base/base.css' %}" />
    <link rel="stylesheet" href="{% static 'diets/diets_main.css' %}" />
    {% csrf_token %}
  </head>
  <body>
    <div class="screen">
      <div class="view">
        <div class="page-title"></div>

        <div class="meal-record-container">
      <div class="nav-bar">
        <div class="nav-left"></div>
        <div class="nav-right"></div>
      </div>
      <!-- 월 네비게이션 -->
      <div class="month-navigation">< 2025년 8월 ></div>
      <!-- 헤더 섹션 -->
      <div class="header-section">
        <div class="section-title">
          <span class="cutlery-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="21" height="24" viewBox="0 0 21 24" fill="none">
              <path d="M4.25043 1.49911L4.00043 6.99911M6.75043 1.49911L7.00043 6.99911M14.6049 1.56861C16.5249 2.99461 19.2084 6.92611 19.4784 12.9976C19.5064 13.6261 19.2004 14.2216 18.6294 14.4866C18.2219 14.6756 17.6709 14.8906 16.9769 15.0736C16.8543 15.1044 16.7472 15.1793 16.6762 15.284C16.6052 15.3886 16.5752 15.5157 16.5919 15.6411L17.2049 19.9301C17.3749 21.1216 16.9084 22.1891 15.7474 22.5086C14.6624 22.8076 13.5004 22.0866 13.5004 20.9606V2.25211C13.5004 1.61011 14.0894 1.18611 14.6049 1.56861ZM9.47293 2.67811C9.70293 4.03711 10.0249 6.41161 9.99893 8.94711C9.98593 10.2556 9.11193 11.4281 7.73793 11.7361C7.45393 11.7996 7.15143 11.8571 6.83543 11.9016L7.75743 19.8916C7.89743 21.1076 7.14443 22.3001 5.93143 22.4641C5.78862 22.4846 5.64468 22.4963 5.50043 22.4991C5.37893 22.4991 5.23143 22.4861 5.06893 22.4641C3.85643 22.3001 3.10343 21.1076 3.24393 19.8916L4.16543 11.9016C3.86269 11.8586 3.56178 11.8036 3.26343 11.7366C1.88893 11.4281 1.01493 10.2551 1.00143 8.94661C0.97593 6.41161 1.29693 4.03761 1.52693 2.67861C1.64393 1.98611 2.24993 1.49911 2.95193 1.49911H8.04793C8.75043 1.49911 9.35593 1.98561 9.47293 2.67811Z" stroke="black" stroke-opacity="0.56" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          식사기록

        </div>
        <button class="add-meal-btn">
          <span class="plus-icon">+</span>
          새 식사
        </button>
      </div>
      <!-- 오늘의 식사 추가하기 -->
      <div class="add-today-meal">
        <div class="add-today-content">
          <span class="plus-icon-large">+</span>
          <span class="add-today-text">오늘의 식사 추가하기</span>
        </div>
      </div>

      <!-- 일별 식사 기록 -->
      <div class="daily-meals">
        {% for date in data %}
        <div class="day-card">
          <div class="day-header">{{ date.date }}</div>

          <!-- 아침 -->
          {% if date.diets.breakfast %} {% for diet in date.diets.breakfast %}
          <div class="meal-item">
            <span class="meal-type">아침</span>
            <span class="meal-content"> {{ diet.food_name }} </span>
            <div class="meal-actions">
              <button
                class="edit-btn"
                type="button"
                data-diet-id="{{ diet.diet_id }}"
                data-food-id="{{ diet.food_id }}"
                data-food-name="{{ diet.food_name }}"
                data-date="{{ date.date }}"
                data-meal="아침"
                onclick="editMeal(this)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="15"
                  height="15"
                  viewBox="0 0 15 15"
                  fill="none"
                >
                  <path
                    d="M1 14.1993H3.82833L14.1993 3.82833L11.3707 1L1 11.371V14.1993Z"
                    stroke="#B7B5B5"
                    stroke-width="1.5"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
              <a
                class="delete-btn"
                data-diet-id="{{ diet.diet_id }}"
                data-food-name="{{ diet.food_name }}"
                onclick="deleteMeal(this)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="14"
                  height="16"
                  viewBox="0 0 14 16"
                  fill="none"
                >
                  <path
                    d="M1 4.11111H12.9255M5.47205 7.22222V11.8889M8.45342 7.22222V11.8889M1.74534 4.11111L2.49068 13.4444C2.49068 13.857 2.64774 14.2527 2.92729 14.5444C3.20685 14.8361 3.58601 15 3.98137 15H9.9441C10.3395 15 10.7186 14.8361 10.9982 14.5444C11.2777 14.2527 11.4348 13.857 11.4348 13.4444L12.1801 4.11111M4.72671 4.11111V1.77778C4.72671 1.5715 4.80524 1.37367 4.94501 1.22781C5.08479 1.08194 5.27437 1 5.47205 1H8.45342C8.65109 1 8.84067 1.08194 8.98045 1.22781C9.12023 1.37367 9.19876 1.5715 9.19876 1.77778V4.11111"
                    stroke="#B7B5B5"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </a>
            </div>
          </div>
          {% endfor %} {% endif %}

          <!-- 점심 -->
          {% if date.diets.lunch %} {% for diet in date.diets.lunch %}
          <div class="meal-item">
            <span class="meal-type">점심</span>
            <span class="meal-content"> {{ diet.food_name }} </span>
            <div class="meal-actions">
              <button
                class="edit-btn"
                type="button"
                data-diet-id="{{ diet.diet_id }}"
                data-food-id="{{ diet.food_id }}"
                data-food-name="{{ diet.food_name }}"
                data-date="{{ date.date }}"
                data-meal="점심"
                onclick="editMeal(this)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="15"
                  height="15"
                  viewBox="0 0 15 15"
                  fill="none"
                >
                  <path
                    d="M1 14.1993H3.82833L14.1993 3.82833L11.3707 1L1 11.371V14.1993Z"
                    stroke="#B7B5B5"
                    stroke-width="1.5"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
              <a
                class="delete-btn"
                data-diet-id="{{ diet.diet_id }}"
                data-food-name="{{ diet.food_name }}"
                onclick="deleteMeal(this)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="14"
                  height="16"
                  viewBox="0 0 14 16"
                  fill="none"
                >
                  <path
                    d="M1 4.11111H12.9255M5.47205 7.22222V11.8889M8.45342 7.22222V11.8889M1.74534 4.11111L2.49068 13.4444C2.49068 13.857 2.64774 14.2527 2.92729 14.5444C3.20685 14.8361 3.58601 15 3.98137 15H9.9441C10.3395 15 10.7186 14.8361 10.9982 14.5444C11.2777 14.2527 11.4348 13.857 11.4348 13.4444L12.1801 4.11111M4.72671 4.11111V1.77778C4.72671 1.5715 4.80524 1.37367 4.94501 1.22781C5.08479 1.08194 5.27437 1 5.47205 1H8.45342C8.65109 1 8.84067 1.08194 8.98045 1.22781C9.12023 1.37367 9.19876 1.5715 9.19876 1.77778V4.11111"
                    stroke="#B7B5B5"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </a>
            </div>
          </div>
          {% endfor %}{% endif %}

          <!-- 저녁 -->
          {% if date.diets.dinner %} {% for diet in date.diets.dinner %}
          <div class="meal-item">
            <span class="meal-type">저녁</span>
            <span class="meal-content"> {{ diet.food_name }} </span>
            <div class="meal-actions">
              <button
                class="edit-btn"
                type="button"
                data-diet-id="{{ diet.diet_id }}"
                data-food-id="{{ diet.food_id }}"
                data-food-name="{{ diet.food_name }}"
                data-date="{{ date.date }}"
                data-meal="저녁"
                onclick="editMeal(this)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="15"
                  height="15"
                  viewBox="0 0 15 15"
                  fill="none"
                >
                  <path
                    d="M1 14.1993H3.82833L14.1993 3.82833L11.3707 1L1 11.371V14.1993Z"
                    stroke="#B7B5B5"
                    stroke-width="1.5"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
              <a
                class="delete-btn"
                data-diet-id="{{ diet.diet_id }}"
                data-food-name="{{ diet.food_name }}"
                onclick="deleteMeal(this)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="14"
                  height="16"
                  viewBox="0 0 14 16"
                  fill="none"
                >
                  <path
                    d="M1 4.11111H12.9255M5.47205 7.22222V11.8889M8.45342 7.22222V11.8889M1.74534 4.11111L2.49068 13.4444C2.49068 13.857 2.64774 14.2527 2.92729 14.5444C3.20685 14.8361 3.58601 15 3.98137 15H9.9441C10.3395 15 10.7186 14.8361 10.9982 14.5444C11.2777 14.2527 11.4348 13.857 11.4348 13.4444L12.1801 4.11111M4.72671 4.11111V1.77778C4.72671 1.5715 4.80524 1.37367 4.94501 1.22781C5.08479 1.08194 5.27437 1 5.47205 1H8.45342C8.65109 1 8.84067 1.08194 8.98045 1.22781C9.12023 1.37367 9.19876 1.5715 9.19876 1.77778V4.11111"
                    stroke="#B7B5B5"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </a>
            </div>
          </div>
          {% endfor %} {% endif %}
        </div>
        {% endfor %}
        </div>
        </div>
      </div>
    </div>
    <script>
      function getCookie(name) {
        const v = `; ${document.cookie}`;
        const p = v.split(`; ${name}=`);
        if (p.length === 2) return p.pop().split(";").shift();
      }

      async function deleteMeal(el) {
        const id = el.dataset.dietId;
        console.log(id);
        const res = await fetch(`/diets/${id}/`, {
          method: "DELETE",
          headers: { "X-CSRFToken": getCookie("csrftoken") },
        });
        if (res.status === 204) {
          el.closest(".meal-item")?.remove(); // 또는: location.reload();
        } else {
          alert(`삭제 실패 (${res.status})`);
        }
      }

      async function editMeal(el) {
        const dietId = el.dataset.dietId;
        const curFood = el.dataset.foodId; // 문자열 (uuid 또는 int)
        const curDate = el.dataset.date; // 'YYYY-MM-DD'
        const curMeal = el.dataset.meal; // 'breakfast' | 'lunch' | 'dinner'
        const url = `/diets/form/${dietId}/?date=${encodeURIComponent(curDate)}&meal=${encodeURIComponent(curMeal)}`;
        window.location.href = url;
        }
        // 프롬프트로 새 값 입력(엔터 치면 기존값 유지)
        function todayYMD() {
            const d = new Date();
            const m = String(d.getMonth() + 1).padStart(2, "0");
            const day = String(d.getDate()).padStart(2, "0");
            return `${d.getFullYear()}-${m}-${day}`;
        }

        // "새 식사" / "오늘의 식사 추가하기" → register 페이지로 이동
        document.querySelector(".add-meal-btn")?.addEventListener("click", () => {
            // 기본: 오늘 날짜만 세팅. 음식/끼니는 register 페이지에서 선택.
            window.location.href = `/diets/list/?date=${todayYMD()}`;
        });

        document.querySelector(".add-today-meal")?.addEventListener("click", () => {
            window.location.href = `/diets/list/?date=${todayYMD()}`;
        });
    </script>

        {% comment %} // PATCH 호출
        const res = await fetch(`/diets/${dietId}/`, {
          method: "PATCH",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            food: newFood, // ✅ 뷰에서 Food.objects.get(food_id=data['food'])로 사용
            date: newDate, // 'YYYY-MM-DD'
            meal: newMeal, // 'breakfast'|'lunch'|'dinner'
          }),
        });

        if (res.ok) {
          location.reload(); // 간단히 새로고침
        } else {
          alert(`수정 실패 (${res.status})`);
        }
      } {% endcomment %}
    
  </body>
</html>
