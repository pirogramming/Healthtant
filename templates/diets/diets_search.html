{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>식사등록페이지 - Healthtant</title>
    <link rel="stylesheet" href="{% static 'diets/diets_search.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <header class="app-header">
        <div class="status-bar"></div>
        <div class="search-section">
            <div class="search-container">
                <button type="button" class="search-input" onclick="performSearch()">
                    <span class="search-placeholder">새 제품을 검색해서 찾아보세요</span>
                    <div class="search-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M9.183 3.62741C6.11475 3.62741 3.62744 6.11472 3.62744 9.18297C3.62744 12.2512 6.11475 14.7385 9.183 14.7385C10.6756 14.7385 12.0307 14.1499 13.0289 13.1921C13.0525 13.1622 13.0781 13.1334 13.1058 13.1057C13.1334 13.0781 13.1622 13.0525 13.1922 13.0289C14.1499 12.0307 14.7386 10.6756 14.7386 9.18297C14.7386 6.11472 12.2512 3.62741 9.183 3.62741ZM15.146 13.7594C16.1202 12.492 16.6993 10.9051 16.6993 9.18297C16.6993 5.03181 13.3342 1.66663 9.183 1.66663C5.03184 1.66663 1.66666 5.03181 1.66666 9.18297C1.66666 13.3341 5.03184 16.6993 9.183 16.6993C10.9052 16.6993 12.492 16.1201 13.7595 15.1459L16.6597 18.0461C17.0426 18.429 17.6633 18.429 18.0462 18.0461C18.429 17.6633 18.429 17.0425 18.0462 16.6597L15.146 13.7594Z" fill="#56AAB2"/>
                        </svg>
                    </div>
                </button>
            </div>
            <button class="cancel-btn" onclick="clearSearch()">취소</button>
        </div>
    </header>
<div class="meal-register-container">

    <!-- 검색 결과 섹션 -->
    <div class="search-results-section" id="searchResults" style="display: none;">
        <h2>검색 결과</h2>
        <div class="search-results-list" id="searchResultsList">
            <!-- 검색 결과가 여기에 동적으로 추가됩니다 -->
        </div>
    </div>
</div>

<script>
function performSearch() {
    const searchInput = document.getElementById('searchInput');
    const keyword = searchInput.value.trim();
    
    if (!keyword) {
        alert('검색어를 입력해주세요.');
        return;
    }
    
    // AJAX 요청
    fetch(`/diets/search/?keyword=${encodeURIComponent(keyword)}`)
        .then(response => response.json())
        .then(data => {
            displaySearchResults(data.foods);
        })
        .catch(error => {
            console.error('검색 중 오류가 발생했습니다:', error);
            alert('검색 중 오류가 발생했습니다.');
        });
}

function displaySearchResults(foods) {
    const searchResults = document.getElementById('searchResults');
    const searchResultsList = document.getElementById('searchResultsList');
    
    if (foods.length === 0) {
        searchResultsList.innerHTML = '<div class="no-results">검색 결과가 없습니다.</div>';
    } else {
        searchResultsList.innerHTML = '';
        
        foods.forEach(food => {
            const foodCard = document.createElement('div');
            foodCard.className = 'food-card';
            foodCard.setAttribute('data-food-id', food.food_id);
            
            foodCard.innerHTML = `
                <div class="food-image">
                    ${food.food_img ? 
                        `<img src="${food.food_img}" alt="${food.food_name}">` : 
                        `<img src="{% static 'diets/images/default-food.jpg' %}" alt="${food.food_name}">`
                    }
                </div>
                <div class="food-info">
                    <h3 class="food-name">${food.food_name}</h3>
                    <p class="food-company">제조사: ${food.company_name}</p>
                </div>
                <button class="register-btn" onclick="registerFood('${food.food_id}')">
                    <span class="plus-icon">+</span>
                    <span class="register-text">등록하기</span>
                </button>
            `;
            
            searchResultsList.appendChild(foodCard);
        });
    }
    
    searchResults.style.display = 'block';
}

function registerFood(foodId) {
    // 오늘 날짜 생성
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const todayString = `${year}-${month}-${day}`;
    
    // diets_upload.html로 이동 (food_id와 오늘 날짜를 파라미터로 전달)
    window.location.href = `/diets/upload/?food=${foodId}&date=${todayString}`;
}

function clearSearch() {
    // diets_main.html로 이동 (오늘 날짜로)
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    
    window.location.href = `/diets/?year=${year}&month=${month}`;
}

// Enter 키로도 검색 가능하도록
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        performSearch();
    }
});
</script>
</body>
</html>