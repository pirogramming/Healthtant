name: Deploy (Build in CI, Pull on Server)

on:
  push:
    branches: ["main"]

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Build & Push image (tag: sha + latest)"
        uses: docker/build-push-action@v5
        env:
          IMAGE: ghcr.io/pirogramming/healthtant
          TAG: ${{ github.sha }}
        with:
          context: .
          push: true
          tags: |
            ghcr.io/pirogramming/healthtant:${{ github.sha }}
            ghcr.io/pirogramming/healthtant:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 300s
          script: |
            set -euo pipefail
            cd ~/Healthtant

            echo "ğŸš€ Starting deployment..."
            
            # Docker ë¡œê·¸ì¸ (ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥í•˜ë„ë¡)
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ secrets.USERNAME }} --password-stdin

            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸
            CURRENT_WEB=$(docker-compose ps -q web 2>/dev/null || echo "")
            
            # 1. ì´ë¯¸ì§€ í’€ (ë°±ê·¸ë¼ìš´ë“œ)
            echo "ğŸ“¦ Pulling new images..."
            docker-compose pull web &
            PULL_PID=$!
            
            # 2. ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´í¬ (í•„ìš”í•œ ê²½ìš°ë§Œ)
            echo "ğŸ” Checking migrations..."
            if [ -n "$CURRENT_WEB" ]; then
              PENDING=$(docker-compose exec -T web python manage.py showmigrations --plan | grep '\[ \]' | wc -l || echo "0")
              if [ "$PENDING" -eq "0" ]; then
                echo "âœ… No pending migrations"
                SKIP_MIGRATE=true
              else
                echo "ğŸ“‹ Found $PENDING pending migrations"
                SKIP_MIGRATE=false
              fi
            else
              echo "ğŸ†• First deployment - will run migrations"
              SKIP_MIGRATE=false
            fi
            
            # ì´ë¯¸ì§€ í’€ ì™„ë£Œ ëŒ€ê¸°
            wait $PULL_PID
            echo "âœ… Images pulled"
            
            # 3. ë¹ ë¥¸ ì¬ì‹œì‘
            echo "ğŸ”„ Restarting services..."
            docker-compose up -d --remove-orphans --no-recreate web
            
            # 4. ì¡°ê±´ë¶€ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
            if [ "$SKIP_MIGRATE" = "false" ]; then
              echo "ğŸ”§ Running migrations..."
              docker-compose exec -T web python manage.py migrate --noinput
            fi
            
            # 5. ì •ì íŒŒì¼ë§Œ í•„ìš”ì‹œ ìˆ˜ì§‘ (ê°œë°œí™˜ê²½ì—ì„œëŠ” ìŠ¤í‚µ)
            if [ "${DJANGO_SETTINGS_MODULE:-}" = "config.settings.production" ]; then
              echo "ğŸ“ Collecting static files..."
              docker-compose exec -T web python manage.py collectstatic --noinput --clear &
            fi
            
            # 6. ë¹ ë¥¸ í—¬ìŠ¤ ì²´í¬
            echo "ğŸ¥ Health check..."
            for i in {1..15}; do
              if docker-compose exec -T web python scripts/health_check.py; then
                echo "âœ… Deployment successful in $(($i * 2)) seconds!"
                break
              fi
              if [ $i -eq 15 ]; then
                echo "âŒ Health check failed after 30 seconds"
                echo "ğŸ“‹ Container logs:"
                docker-compose logs --tail=20 web
                exit 1
              fi
              sleep 2
            done
            
            wait # ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì™„ë£Œ ëŒ€ê¸°