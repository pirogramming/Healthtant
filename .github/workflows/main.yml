name: Deploy (Build in CI, Pull on Server)

on:
  push:
    branches: ["main"]

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Build & Push image (tag: sha + latest)"
        uses: docker/build-push-action@v5
        env:
          IMAGE: ghcr.io/pirogramming/healthtant
          TAG: ${{ github.sha }}
        with:
          context: .
          push: true
          tags: |
            ghcr.io/pirogramming/healthtant:${{ github.sha }}
            ghcr.io/pirogramming/healthtant:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

    deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }} 
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 600s
          command_timeout: 300s
          script: |
            set -euo pipefail

            echo "ğŸš€ Starting deployment at $(date)"
            echo "whoami=$(whoami)  HOME=$HOME"

            # 1) í”„ë¡œì íŠ¸ ê²½ë¡œ ì°¾ê¸° (ì—†ìœ¼ë©´ ìµœì´ˆ í´ë¡ )
            if   [ -d /root/Healthtant ]; then cd /root/Healthtant
            elif [ -d /home/ubuntu/Healthtant ]; then cd /home/ubuntu/Healthtant
            elif [ -d "$HOME/Healthtant" ]; then cd "$HOME/Healthtant"
            else
              echo "ğŸ“¦ First-time setup: cloning repo to /opt/apps"
              sudo mkdir -p /opt/apps && sudo chown -R "$(whoami)":"$(whoami)" /opt/apps
              cd /opt/apps
              git clone --depth 1 https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/pirogramming/Healthtant.git
              cd Healthtant
            fi
            echo "ğŸ“‚ Using project dir: $(pwd)"

            # 2) ì½”ë“œ ìµœì‹ í™”
            echo "ğŸ”„ Updating code from git..."
            git fetch origin main
            git reset --hard origin/main
            echo "âœ… Code updated"

            # 3) compose ëª…ë ¹ ê°ì§€(ì—†ìœ¼ë©´ ì„¤ì¹˜)
            if docker compose version >/dev/null 2>&1; then COMPOSE="docker compose";
            elif docker-compose --version >/dev/null 2>&1; then COMPOSE="docker-compose";
            else
              echo "ğŸ§© Installing docker compose plugin..."
              sudo apt-get update -y
              sudo apt-get install -y docker-compose-plugin
              COMPOSE="docker compose"
            fi
            echo "âœ… Using: $COMPOSE"

            # 4) GHCR ë¡œê·¸ì¸ (actor ì‚¬ìš©)
            echo "ğŸ” Logging into GHCR..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            echo "âœ… Docker login successful"

            # 5) compose íŒŒì¼ í™•ì¸
            test -f docker-compose.yml || { echo "âŒ docker-compose.yml not found"; exit 1; }

            # 6) ì´ë¯¸ì§€ pull & ê¸°ë™
            echo "ğŸ“¦ Pulling images..."
            timeout 180 $COMPOSE pull
            echo "ğŸ”„ Starting services..."
            timeout 120 $COMPOSE up -d --remove-orphans
            echo "âœ… Services started"

            # 7) í—¬ìŠ¤ ì²´í¬
            echo "ğŸ¥ Health check..."
            sleep 5
            for i in {1..10}; do
              echo "ğŸ” Health check attempt $i/10..."
              if ! $COMPOSE ps | grep -q "Up"; then
                $COMPOSE ps || true
                $COMPOSE logs --tail=50 web || true
                [ $i -eq 10 ] && { echo "âŒ Containers not running"; exit 1; }
                sleep 3; continue
              fi

              if $COMPOSE exec -T web timeout 10 python -c 'import socket,sys; s=socket.socket(); s.settimeout(5); r=s.connect_ex(("localhost",8000)); s.close(); print("âœ… 8000 open" if r==0 else "âŒ 8000 closed"); sys.exit(0 if r==0 else 1)'; then
                echo "âœ… Deployment successful!"
                $COMPOSE ps || true
                break
              fi

              [ $i -eq 10 ] && { echo "âŒ Health check failed"; $COMPOSE logs --tail=100 web || true; exit 1; }
              sleep 3
            done

            echo "ğŸ‰ Deployment completed at $(date)"