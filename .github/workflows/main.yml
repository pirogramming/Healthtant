name: Deploy (Build in CI, Pull on Server)

on:
  push:
    branches: ["main"]

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Build & Push image (tag: sha + latest)"
        uses: docker/build-push-action@v5
        env:
          IMAGE: ghcr.io/pirogramming/healthtant
          TAG: ${{ github.sha }}
        with:
          context: .
          push: true
          tags: |
            ghcr.io/pirogramming/healthtant:${{ github.sha }}
            ghcr.io/pirogramming/healthtant:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 600s
          command_timeout: 300s
          script: |
            set -euo pipefail
            
            echo "ğŸš€ Starting deployment at $(date)"
            echo "ğŸ“‚ Working directory: $(pwd)"
            
            # ë””ë ‰í† ë¦¬ í™•ì¸ ë° ì´ë™
            if [ ! -d "~/Healthtant" ]; then
              echo "âŒ Directory ~/Healthtant not found!"
              echo "ğŸ“‹ Available directories:"
              ls -la ~/ || true
              exit 1
            fi
            
            cd ~/Healthtant
            echo "ğŸ“‚ Changed to: $(pwd)"
            echo "ğŸ“‹ Directory contents:"
            ls -la . || true
            
            # Docker ë° docker-compose í™•ì¸
            echo "ğŸ³ Checking Docker..."
            if ! command -v docker &> /dev/null; then
              echo "âŒ Docker not found!"
              exit 1
            fi
            
            if ! command -v docker-compose &> /dev/null; then
              echo "âŒ docker-compose not found!"
              exit 1
            fi
            
            echo "âœ… Docker version: $(docker --version)"
            echo "âœ… Docker-compose version: $(docker-compose --version)"
            
            # Docker ë¡œê·¸ì¸ ì‹œë„
            echo "ğŸ” Logging into Docker registry..."
            if ! echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ secrets.USERNAME }} --password-stdin; then
              echo "âŒ Docker login failed!"
              exit 1
            fi
            echo "âœ… Docker login successful"
            
            # docker-compose.yml í™•ì¸
            if [ ! -f "docker-compose.yml" ]; then
              echo "âŒ docker-compose.yml not found!"
              ls -la . || true
              exit 1
            fi
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸
            echo "ğŸ” Checking current containers..."
            docker-compose ps || true
            
            # ì´ë¯¸ì§€ í’€
            echo "ğŸ“¦ Pulling new images..."
            if ! timeout 180 docker-compose pull; then
              echo "âŒ Image pull failed or timed out!"
              exit 1
            fi
            echo "âœ… Images pulled successfully"
            
            # ì„œë¹„ìŠ¤ ì‹œì‘/ì¬ì‹œì‘
            echo "ğŸ”„ Starting services..."
            if ! timeout 120 docker-compose up -d --remove-orphans; then
              echo "âŒ Service start failed or timed out!"
              echo "ğŸ“‹ Container logs:"
              docker-compose logs --tail=50 || true
              exit 1
            fi
            echo "âœ… Services started"
            
            # ê°„ë‹¨í•œ í—¬ìŠ¤ ì²´í¬
            echo "ğŸ¥ Health check..."
            sleep 5  # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
            
            for i in {1..10}; do
              echo "ğŸ” Health check attempt $i/10..."
              
              # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
              if ! docker-compose ps | grep -q "Up"; then
                echo "âš ï¸  Containers not running properly"
                docker-compose ps || true
                docker-compose logs --tail=20 web || true
                if [ $i -eq 10 ]; then
                  echo "âŒ Health check failed - containers not running"
                  exit 1
                fi
                sleep 3
                continue
              fi
              
              # ì›¹ ì„œë¹„ìŠ¤ í™•ì¸ (í¬íŠ¸ ì²´í¬)
              if docker-compose exec -T web timeout 10 python -c "
import socket
import sys
try:
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(5)
    result = sock.connect_ex(('localhost', 8000))
    sock.close()
    if result == 0:
        print('âœ… Port 8000 is open')
        sys.exit(0)
    else:
        print('âŒ Port 8000 is not accessible')
        sys.exit(1)
except Exception as e:
    print(f'âŒ Health check error: {e}')
    sys.exit(1)
"; then
                echo "âœ… Deployment successful!"
                echo "ğŸ“Š Final container status:"
                docker-compose ps || true
                break
              fi
              
              if [ $i -eq 10 ]; then
                echo "âŒ Health check failed after 10 attempts"
                echo "ğŸ“‹ Final container logs:"
                docker-compose logs --tail=30 web || true
                exit 1
              fi
              
              sleep 3
            done
            
            echo "ğŸ‰ Deployment completed at $(date)"